---
title: "Untitled"
output: html_document
date: "2025-08-21"
---

```{r setup, message=FALSE, warning=FALSE}
# Load required libraries
library(ggplot2)
library(dCovTS)
library(forecast)
library(dplyr)
library(gridExtra)
library(seasonal)
library(astsa)
library(fpp3)
library(MASS)
library(tidyverse)
library(distributional)

# Set seed for reproducibility
set.seed(1)
```

## R Markdown



```{r cars}
fit <- us_change |>
  model(
    aicc = VAR(vars(Consumption, Income)),
    bic = VAR(vars(Consumption, Income), ic = "bic")
  )
glance(fit)
```



```{r pressure, echo=FALSE}
fit |>
  augment() |>
  ACF(.innov) |>
  autoplot()
```



```{r}
fit |>
  dplyr::select(aicc) |>
  forecast(h=10) |>
  autoplot(us_change |> filter(year(Quarter) > 2010))
```


## Test: Fit and Predict DRF on data

```{r}
library(drf)
source("drfown.R")
n<-length(us_change$Consumption)

Yall<-as.matrix(us_change[,c("Consumption", "Income")])

## Step 1: Plot autocorrelation function:
dCovTS::mADCFplot(Yall)

## Thoughts: We don't really have residuals! (except in the Hilbert space),
## so how do we use the ACF? What we really need is 
## t \indep Y_t \mid X_t #-> Ask Davide about this!!

# lag 1
X<-as.matrix(Yall[1:(n-1),])
Y<-as.matrix(Yall[2:n,])

H<-10

fit<-drfown(X=X, Y=Y)

B<-100

p<-ncol(Yall)

Ypred<-list() ##list of length H+1, each element contains B replicate of the h prediction step
Ypred[[1]]<-matrix(Yall[n,],nrow=B, ncol=p, byrow = T) ## each element of Ypred contains 

colnames(Ypred[[1]])<-colnames(Yall)

##Predict a path
  
  for (h in 2:(H+1)){
    # start from last (h-1) prediction in the same "world" b 
    DRFw <- predict(fit, newdata =Ypred[[h-1]] )$weights
    ## Draw path
    sig<-abs(n^(-1/5)/drf:::medianHeuristic(Y))
    
    Ypred[[h]]<-t(apply(DRFw,1, function(w){
    mean<-Y[sample(1:nrow(Y), size=1, replace = T, w),]
    return(mvrnorm(n=1, mu = mean, Sigma = sig^2 * diag(p)))
    }
    ))
    
  }
  

### Continue here!!!

h <- length(Ypred)  # forecast horizon

forecast_periods <- us_change %>% 
  new_data(n = h) %>% 
  pull(Quarter)  # or whatever your time index column is named

forecast_periods



# Convert Ypred to a fable (forecast table)
forecast_df <- tibble(
  Quarter = forecast_periods,
  .model = "DRF",  # or whatever model name you prefer
  .distribution=dist_sample(x = Ypred)
) |>
  as_fable(key = .model, index = Quarter, 
           response = c("Consumption", "Income"), 
           distribution = .distribution)   


forecast_df|>
autoplot(us_change |> filter(year(Quarter) > 2010))
